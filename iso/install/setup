#!/bin/sh

GRUBVER="2.12"
BASEVER="1.0"

KARLS=`cat /mnt/iso/karls_iso`
echo ""
echo "Welcome to $KARLS ISO Installation/Live System"

while true; do

echo ""
echo "Press Any Key to start Installation or \"S\" to drop to Live ISO Shell"
read -s -n 1
REP=`echo $REPLY | tr '[:upper:]' '[:lower:]'`
[[ "$REP" == "s" ]] && exit 0

echo ""
echo "                        * * * WARNING * * *"
echo ""
echo "Installing KarLS on a disk will DESTROY all other data on that disk!"
echo ""
echo "Possible installation target candidates:"
fdisk -l | grep Disk
echo ""
echo -n "Enter device to install: "
read
[[ ! -b "$REPLY" ]] && { echo "[$REPLY] not found or not a device!"; continue; }
TRGT="$REPLY"

echo ""
echo "Insallation target is [$TRGT]!"
fdisk -l $TRGT
echo ""
echo "             * * * LAST CHANCE! Do you really want to continue? * * *"
echo ""
echo "KarLS will be installed on [$TRGT], and all pre-existing data will be destroyed there!"
echo ""
echo -n "Type \"YES\" to continue installation: "
read
[[ "$REPLY" != "YES" ]] && { echo "Installation cancelled!"; continue; }

echo "Partitioning disk..."
echo -e "o\nn\np\n1\n2048\n\na\n1\nw\n" | fdisk $TRGT > /dev/null
[[ $? -ne 0 ]] && { echo "fdisk error, installation cancelled!"; break; }

echo "Formatting ext2 partition..."
mkfs.ext2 "$TRGT"1 > /dev/null
[[ $? -ne 0 ]] && { echo "mkfs.ext2 error, installation cancelled!"; break; }

echo "Mounting target..."
mkdir -p /mnt/target
mount "$TRGT"1 /mnt/target > /dev/null
[[ $? -ne 0 ]] && { echo "mount error, installation cancelled!"; break; }

echo "Installing Kernel files..."
KVER=`cat /mnt/iso/boot/kernel_version`
mkdir -p /mnt/target/boot/grub /mnt/target/etc/kpm
cp /etc/kpm/repo /mnt/target/etc/kpm
kpm install kernel-$KVER /mnt/target
[[ $? -ne 0 ]] && { echo "kpm error, installation cancelled!"; break; }

echo "Installing GRUB boot loader..."

kpm install grub-$GRUBVER
[[ $? -ne 0 ]] && { echo "kpm error, installation cancelled!"; break; }

grub-install --boot-directory=/mnt/target/boot "$TRGT"
[[ $? -ne 0 ]] && { echo "grub-install error, installation cancelled!"; break; }

cp /mnt/iso/install/grub.cfg /mnt/target/boot/grub

SERIALCON=`grep console=ttyS0 /proc/cmdline`
if [ -z "$SERIALCON" ]; then
 echo "set default=0" >> /mnt/target/boot/grub/grub.cfg
else
 echo "Installing over Serial Console, setting as default choice for boot menu"
 echo "set default=1" >> /mnt/target/boot/grub/grub.cfg
fi

echo "" >> /mnt/target/boot/grub/grub.cfg

BLK=`blkid "$TRGT"1 | cut -d' ' -f2 | cut -d= -f2`

echo "menuentry \"KarLS\" {" >> /mnt/target/boot/grub/grub.cfg
echo "	search -u $BLK --set=root" >> /mnt/target/boot/grub/grub.cfg
echo "	linux /boot/vmlinuz-$KVER vga=0x305 root=$BLK" >> /mnt/target/boot/grub/grub.cfg
echo "	initrd /boot/initrd-$KVER.gz" >> /mnt/target/boot/grub/grub.cfg
echo "}" >> /mnt/target/boot/grub/grub.cfg
echo "" >> /mnt/target/boot/grub/grub.cfg
echo "menuentry \"KarLS Serial Console\" {" >> /mnt/target/boot/grub/grub.cfg
echo "	search -u $BLK --set=root" >> /mnt/target/boot/grub/grub.cfg
echo "	linux /boot/vmlinuz-$KVER console=ttyS0,9600 root=$BLK" >> /mnt/target/boot/grub/grub.cfg
echo "	initrd /boot/initrd-$KVER.gz" >> /mnt/target/boot/grub/grub.cfg
echo "}" >> /mnt/target/boot/grub/grub.cfg

echo "Installing base OS packages..."

kpm install karls_base-$BASEVER /mnt/target
[[ $? -ne 0 ]] && { echo "kpm error, installation cancelled!"; break; }

if [ -z "$SERIALCON" ]; then
 rm /mnt/target/etc/inittab-serial
else
 mv /mnt/target/etc/inittab-serial /mnt/target/etc/inittab
fi

kpm install grub-$GRUBVER /mnt/target
[[ $? -ne 0 ]] && { echo "kpm error, installation cancelled!"; break; }

echo ""
echo "KarLS Installation finished!"
break

done

echo ""
echo "Press Any Key to Reboot or \"S\" to drop to Live ISO Shell"
read -s -n 1
REP=`echo $REPLY | tr '[:upper:]' '[:lower:]'`
[[ "$REP" == "s" ]] && exit 0

#Force reboot
sync
umount -r /mnt/target
echo 1 > /proc/sys/kernel/sysrq
echo b > /proc/sysrq-trigger
