#!/bin/sh

#Unpack musl and grub to ramdisk
kpm install /mnt/iso/packages/musl-1.2.5.kp >/dev/null
kpm install /mnt/iso/packages/grub-2.12.kp >/dev/null

KARLS=`cat /mnt/iso/karls_iso`
echo ""
echo "Welcome to $KARLS Installation/Live ISO"

while true; do

echo ""
echo "Press Any Key to start Installation or \"S\" to drop to Live ISO Shell"
read -s -n 1
REP=`echo $REPLY | tr '[:upper:]' '[:lower:]'`
[[ "$REP" == "s" ]] && exit 0

echo ""
echo "                        * * * WARNING * * *"
echo ""
echo "Installing KarLS on a disk will DESTROY all other data on that disk!"
echo ""
echo "Possible installation target candidates:"
fdisk -l | grep Disk
echo ""
echo -n "Enter device to install: "
read
[[ ! -b "$REPLY" ]] && { echo "[$REPLY] not found or not a device!"; continue; }
TRGT="$REPLY"

echo ""
echo "Insallation target is [$TRGT]!"
fdisk -l $TRGT
echo ""
echo "             * * * LAST CHANCE! Do you really want to continue? * * *"
echo ""
echo "KarLS will be installed on [$TRGT], and all pre-existing data will be destroyed there!"
echo ""
echo -n "Type \"YES\" to continue installation: "
read
[[ "$REPLY" != "YES" ]] && { echo "Installation cancelled!"; continue; }

echo "Partitioning disk..."
echo -e "o\nn\np\n1\n2048\n\na\n1\nw\n" | fdisk $TRGT > /dev/null
ret=$?
[[ $ret -ne 0 ]] && { echo "fdisk error, installation cancelled!"; break; }

echo "Formatting ext2 partition..."
mkfs.ext2 "$TRGT"1 > /dev/null
ret=$?
[[ $ret -ne 0 ]] && { echo "mkfs.ext2 error, installation cancelled!"; break; }

echo "Mounting target..."
mkdir -p /mnt/target
mount "$TRGT"1 /mnt/target > /dev/null
ret=$?
[[ $ret -ne 0 ]] && { echo "mount error, installation cancelled!"; break; }

KVER=`cat /mnt/iso/boot/kernel_version`

echo "Copying kernel files..."
mkdir -p /mnt/target/boot/grub
kpm install /mnt/iso/packages/kernel-$KVER.kp /mnt/target >/dev/null
ret=$?
[[ $ret -ne 0 ]] && { echo "kpm error, installation cancelled!"; break; }

echo "Installing GRUB boot loader..."
grub-install --boot-directory=/mnt/target/boot "$TRGT"
ret=$?
[[ $ret -ne 0 ]] && { echo "grub-install error, installation cancelled!"; break; }

cp /mnt/iso/install/grub.cfg /mnt/target/boot/grub

BLK=`blkid "$TRGT"1 | cut -d' ' -f2 | cut -d= -f2`

echo "menuentry \"KarLS\" {" >> /mnt/target/boot/grub/grub.cfg
echo "	search -u $BLK --set=root" >> /mnt/target/boot/grub/grub.cfg
echo "	linux /boot/vmlinuz-$KVER vga=0x305 root=$BLK" >> /mnt/target/boot/grub/grub.cfg
echo "	initrd /boot/initrd-$KVER.gz" >> /mnt/target/boot/grub/grub.cfg
echo "}" >> /mnt/target/boot/grub/grub.cfg
echo "" >> /mnt/target/boot/grub/grub.cfg
echo "menuentry \"KarLS Serial Console\" {" >> /mnt/target/boot/grub/grub.cfg
echo "	search -u $BLK --set=root" >> /mnt/target/boot/grub/grub.cfg
echo "	linux /boot/vmlinuz-$KVER console=ttyS0,9600 root=$BLK" >> /mnt/target/boot/grub/grub.cfg
echo "	initrd /boot/initrd-$KVER.gz" >> /mnt/target/boot/grub/grub.cfg
echo "}" >> /mnt/target/boot/grub/grub.cfg

echo ""
echo "KarLS Installation finished!"
break

done

echo ""
echo "Press Any Key to Reboot or \"S\" to drop to Live ISO Shell"
read -s -n 1
REP=`echo $REPLY | tr '[:upper:]' '[:lower:]'`
[[ "$REP" == "s" ]] && exit 0

umount /mnt/target 2> /dev/null
reboot
